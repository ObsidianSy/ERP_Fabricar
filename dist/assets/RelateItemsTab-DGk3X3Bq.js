import{r as l,a as me,j as e,J as fe,K as ve,L as ke,M as Se,P as q,N as we,A as ne,l as ie,m as G,t as Ne,O as W,T as he,x as xe,y as z,z as f,D as pe,E as x,S as oe,g as re,h as le,i as ce,Q as je,k as ee,I as Y,B as N,V as Ce,W as _e,X as ye,R as ge,w as Ke,o as F,p as be,b as Ie,C as Te,c as Ue,d as Pe,e as Ee,s as Z,f as Me,Y as Re,Z as qe,_ as ze,$ as De,a0 as $e,a1 as Ae,a2 as Be}from"./index-Cc8Dvf1k.js";import{u as Fe}from"./useImportData-z9QLlESq.js";function Ve({isOpen:de,onClose:p,onKitRelated:V,rawId:L,skuOriginal:U,availableProducts:K}){const[u,P]=l.useState([{sku:"",quantidade:1}]),[O,se]=l.useState(""),[E,b]=l.useState(""),[M,S]=l.useState(0),[m,j]=l.useState(null),[D,I]=l.useState(!1);l.useState(!1);const[$,w]=l.useState(!1),{toast:c}=me(),y=K.filter(a=>a&&(a["Tipo Produto"]||a.tipo_produto)!=="KIT");l.useEffect(()=>{let a=0;u.forEach(t=>{if(t.sku&&t.quantidade>0){const r=y.find(o=>(o.SKU||o.sku)===t.sku);if(r){const o=parseFloat(r["PreÃ§o UnitÃ¡rio"]||r.preco_unitario||0);a+=o*t.quantidade}}}),S(a)},[u,y]);const A=()=>{P([...u,{sku:"",quantidade:1}])},C=a=>{u.length>1&&P(u.filter((t,r)=>r!==a))},R=(a,t,r)=>{const o=[...u];if(t==="sku"){const s=o.findIndex((i,n)=>n!==a&&i.sku===r);s>=0?(o[s].quantidade+=o[a].quantidade,o.splice(a,1)):o[a][t]=r}else o[a][t]=r;P(o)},v=()=>u.filter(t=>t.sku&&t.quantidade>0).length===0?(c({title:"ValidaÃ§Ã£o",description:"Adicione pelo menos um componente ao kit.",variant:"destructive"}),!1):!0,H=async()=>{if(v()){I(!0),j(null);try{const a=u.filter(o=>o.sku&&o.quantidade>0).map(o=>({sku:o.sku.toUpperCase(),q:o.quantidade}));console.log("ðŸ” [Modal] Buscando kit existente:",{components:a});const t=await F.findKitByComposition(a);console.log("ðŸ“¦ [Modal] Resultado completo recebido:",t),console.log("ðŸŽ¯ [Modal] sku_kit extraÃ­do:",t.sku_kit);const r=t.sku_kit&&typeof t.sku_kit=="string"&&t.sku_kit.trim().length>0;if(console.log("âœ… [Modal] SKU vÃ¡lido?",r,"| Valor:",t.sku_kit),r){const o=t.sku_kit.trim();console.log("ðŸŽ‰ [Modal] Kit encontrado:",o),j({found:!0,sku:o}),c({title:"Kit encontrado",description:`Kit existente: ${o}`})}else console.log("âŒ [Modal] Nenhum kit encontrado (sku_kit vazio ou null)"),j({found:!1}),c({title:"Kit nÃ£o encontrado",description:"Nenhum kit existente encontrado. VocÃª pode criar um novo."})}catch(a){console.error("âŒ [Modal] Erro ao buscar kit:",a),c({title:"Erro",description:"NÃ£o foi possÃ­vel verificar o kit. Tente novamente.",variant:"destructive"})}finally{I(!1)}}},Q=async()=>{if(v())try{const a=u.filter(o=>o.sku&&o.quantidade>0).map(o=>({sku:o.sku.toUpperCase(),q:o.quantidade})),t={raw_id:L,kit:{nome:O||U,categoria:E||"Sem Categoria",preco_unitario:M},components:a};console.log("âœ¨ Criando kit e relacionando:",t);const{sku_kit:r}=await F.createKitAndRelate(t);c({title:"Kit criado",description:`Kit criado e item relacionado com sucesso: ${r}`}),V(r),p()}catch(a){console.error("Erro ao criar kit:",a),c({title:"Erro",description:a.message||"NÃ£o foi possÃ­vel criar o kit. Tente novamente.",variant:"destructive"})}},X=async()=>{if(!(m!=null&&m.sku))return;w(!0);const a={raw_id:L,sku:m.sku,source:"direct",learn_alias:!0,alias_text:U};console.log("ðŸš€ [KitRelationModal] Enviando para relateItem:",a);try{const t=await F.relateItem(a);t.ok?(c({title:"Kit relacionado",description:`Item relacionado ao kit ${m.sku}`}),V(m.sku),p()):c({title:"Erro ao relacionar",description:{raw_not_found:"Item nÃ£o encontrado (raw_id invÃ¡lido)",already_related:"Este item jÃ¡ estÃ¡ relacionado",invalid_payload:"Dados invÃ¡lidos enviados ao servidor",sku_empty:"SKU estÃ¡ vazio",source_invalid:"Tipo de relacionamento invÃ¡lido",timeout:"Tempo limite excedido (30s)",network_error:"Erro de rede - verifique sua conexÃ£o"}[t.error||""]||t.error||"Erro desconhecido",variant:"destructive"})}catch(t){console.error("âŒ [KitRelationModal] ExceÃ§Ã£o:",t),c({title:"Erro",description:"Falha ao relacionar o kit. Tente novamente.",variant:"destructive"})}finally{w(!1)}},ae=a=>{const t=y.find(r=>(r.SKU||r.sku)===a);return parseFloat((t==null?void 0:t["PreÃ§o UnitÃ¡rio"])||(t==null?void 0:t.preco_unitario)||0)};return e.jsx(fe,{open:de,onOpenChange:p,children:e.jsxs(ve,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ke,{children:[e.jsxs(Se,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5"}),"Relacionar como KIT"]}),e.jsx(we,{children:"Monte os componentes que formam este kit."})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(ne,{children:[e.jsx(ie,{className:"h-4 w-4"}),e.jsxs(G,{children:["SKU Original: ",e.jsx("strong",{children:U})]})]}),m&&e.jsx(ne,{className:m.found?"border-success bg-success/10":"border-warning bg-warning/10",children:m.found?e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"h-4 w-4 text-success"}),e.jsxs(G,{children:["âœ… Kit existente encontrado: ",e.jsx("strong",{children:m.sku})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4 text-warning"}),e.jsx(G,{children:"âš ï¸ Nenhum kit encontrado com essa composiÃ§Ã£o. VocÃª pode criar um novo kit."})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Componentes do KIT *"}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(he,{children:[e.jsx(xe,{children:e.jsxs(z,{children:[e.jsx(f,{children:"SKU do Componente"}),e.jsx(f,{className:"w-[150px]",children:"Quantidade"}),e.jsx(f,{className:"w-[120px]",children:"PreÃ§o Unit."}),e.jsx(f,{className:"w-[120px]",children:"Subtotal"}),e.jsx(f,{className:"w-[80px]",children:"AÃ§Ãµes"})]})}),e.jsx(pe,{children:u.map((a,t)=>{const r=a.sku?ae(a.sku):0,o=r*a.quantidade;return e.jsxs(z,{children:[e.jsx(x,{children:e.jsxs(oe,{value:a.sku,onValueChange:s=>R(t,"sku",s),children:[e.jsx(re,{children:e.jsx(le,{placeholder:"Selecione SKU"})}),e.jsx(ce,{children:je(y,s=>String(s.SKU||s.sku)).map(s=>e.jsxs(ee,{value:String(s.SKU||s.sku),children:[String(s.SKU||s.sku)," â€” ",s["Nome Produto"]||s.nome_produto]},String(s.SKU||s.sku)))})]})}),e.jsx(x,{children:e.jsx(Y,{type:"number",min:"0.01",step:"0.01",value:a.quantidade,onChange:s=>R(t,"quantidade",parseFloat(s.target.value)||0)})}),e.jsx(x,{className:"text-sm text-muted-foreground",children:r.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx(x,{className:"font-medium",children:o.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx(x,{children:e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>C(t),disabled:u.length===1,children:e.jsx(Ce,{className:"h-4 w-4"})})})]},t)})})]})}),e.jsxs(N,{variant:"outline",size:"sm",onClick:A,className:"w-full",children:[e.jsx(_e,{className:"h-4 w-4 mr-2"}),"Adicionar Componente"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"nomeKit",children:"Nome do Kit (opcional)"}),e.jsx(Y,{id:"nomeKit",value:O,onChange:a=>se(a.target.value),placeholder:U})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"categoria",children:"Categoria (opcional)"}),e.jsx(Y,{id:"categoria",value:E,onChange:a=>b(a.target.value),placeholder:"Ex: AcessÃ³rios"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"preco",children:"PreÃ§o UnitÃ¡rio (opcional)"}),e.jsx(Y,{id:"preco",type:"number",min:"0",step:"0.01",value:M,onChange:a=>S(parseFloat(a.target.value)||0)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Calculado automaticamente a partir dos componentes (pode editar)"})]})]}),e.jsx(ye,{className:"flex-col sm:flex-row gap-2",children:m!=null&&m.found?e.jsx(N,{onClick:X,disabled:$,className:"w-full sm:w-auto",children:$?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"h-4 w-4 mr-2 animate-spin"}),"Relacionando..."]}):"Relacionar com este kit"}):e.jsxs(e.Fragment,{children:[e.jsxs(N,{variant:"outline",onClick:H,disabled:D,className:"w-full sm:w-auto",children:[e.jsx(Ke,{className:`h-4 w-4 mr-2 ${D?"animate-spin":""}`}),D?"Verificando...":"Buscar kit existente"]}),e.jsxs(N,{onClick:Q,className:"w-full sm:w-auto",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Criar kit e relacionar"]})]})})]})})}const te=.8,He=l.memo(function(){const{selectedClientId:p,setSelectedClientId:V,availableClients:L,isLoadingClients:U}=be(),[K,u]=l.useState(new Set),[P,O]=l.useState({}),[se,E]=l.useState(!1),[b,M]=l.useState(null),[S,m]=l.useState(1),[j,D]=l.useState(20),[I,$]=l.useState(0),{toast:w}=me(),{data:c}=Ie("Estoque"),{pendingItems:y,isLoading:A,loadPendingItems:C,manualMatch:R}=Fe(),v=l.useMemo(()=>{const s=new Map;return y.forEach(i=>{if(i.id_pedido&&i.sku_original){const n=`${i.id_pedido}-${i.sku_original}`;s.has(n)||s.set(n,i)}}),Array.from(s.values())},[y]),H=l.useCallback((s,i)=>{if(!s||!i)return[];const n=s.toUpperCase().trim(),g=n.split(/[\s\-_]/)[0];return i.filter(h=>{const _=h.SKU;return _&&String(_).trim()!==""}).map(h=>{const _=String(h.SKU).toUpperCase().trim(),J=String(h["Nome Produto"]||"").toUpperCase();let T=.7;return _===n?T=1:_.includes(n)||n.includes(_)?T=.9:J.includes(g)&&(T=.8),{sku:h.SKU,name:h["Nome Produto"],score:T}}).sort((h,_)=>_.score-h.score).slice(0,3)},[]),Q=l.useMemo(()=>{const s={};return v.forEach(i=>{i.id_raw&&i.sku_original&&(s[i.id_raw]=H(i.sku_original,c||[]))}),s},[v,c,H]);l.useEffect(()=>{(async()=>{const i=await C(S,j,p||void 0);try{const n=await F.getImportSummary({clientId:p||void 0});$(n.pendentes)}catch{$(i.length)}})()},[S,j,p,C]);const X=l.useCallback(async(s,i,n="manual")=>{if(!i||i.trim()===""){w({title:"SKU InvÃ¡lido",description:"Por favor, selecione um SKU vÃ¡lido.",variant:"destructive"});return}try{const g=y.find(k=>k.id_raw===s),d=await R(s,i,g,n);d.ok?(w({title:"Relacionamento confirmado",description:n==="alias"?"SugestÃ£o aprovada e padrÃ£o aprendido!":"Item relacionado e padrÃ£o aprendido."}),await C(S,j,p||void 0)):w({title:"Erro no relacionamento",description:{raw_not_found:"Item nÃ£o encontrado no banco",already_related:"Este item jÃ¡ foi relacionado",invalid_payload:"Dados invÃ¡lidos",sku_empty:"SKU vazio",raw_id_invalid:"ID do item invÃ¡lido",source_invalid:"Tipo de relacionamento invÃ¡lido",timeout:"Tempo limite excedido (30s)",network_error:"Erro de conexÃ£o com o servidor"}[d.error||""]||d.error||"Erro desconhecido",variant:"destructive"})}catch(g){console.error("Erro no relacionamento manual:",g),w({title:"Erro no relacionamento",description:"NÃ£o foi possÃ­vel relacionar o item.",variant:"destructive"})}},[y,R,C,w]),ae=async()=>{const s=Array.from(K);let i=0,n=0,g=0;w({title:"Processando",description:`Confirmando ${s.length} sugestÃµes...`});for(const k of s){const h=y.find(B=>B.id_raw===k),J=(Q[k]||[]).filter(B=>B.sku&&String(B.sku).trim()!==""&&B.score>=te);if(J.length===0){g++,console.warn(`[batch] Item ${k} ignorado: sem sugestÃ£o vÃ¡lida >= ${te}`);continue}const T=J[0];console.info("[batch] Enviando",{raw_id:k,sku:T.sku,score:T.score,source:"alias"});const ue=await R(k,T.sku,h,"alias");ue.ok?i++:(n++,console.error(`[batch] Erro ao confirmar item ${k}:`,ue.error))}u(new Set),await C(S,j,p||void 0),s.length;const d=[`âœ“ ${i} confirmados`];n>0&&d.push(`âœ— ${n} erros`),g>0&&d.push(`âŠ˜ ${g} ignorados (score < ${te*100}%)`),w({title:n>i?"Processamento com erros":"ConcluÃ­do",description:d.join(" | "),variant:n>i?"destructive":"default"})},a=s=>{const i=new Set(K);i.has(s)?i.delete(s):i.add(s),u(i)},t=l.useCallback(s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s),[]),r=s=>{M(s),E(!0)},o=async s=>{if(b!=null&&b.id_raw){E(!1),M(null);try{await F.autoRelateAll(),await C(S,j,p||void 0),w({title:"Sucesso",description:`Item relacionado ao kit ${s}`})}catch(i){console.error("Error refreshing after kit relation:",i),await C(S,j,p||void 0)}}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(Te,{children:[e.jsx(Ue,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx(Pe,{className:"text-lg",children:"Relacionar Itens"}),e.jsx(Ee,{children:"Vincule os itens pendentes com SKUs do estoque"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs(oe,{value:p||"Todos",onValueChange:s=>{V(s==="Todos"?null:s),m(1)},disabled:U,children:[e.jsx(re,{className:"w-[200px]",children:e.jsx(le,{placeholder:U?"Carregando...":"Todos os clientes"})}),e.jsxs(ce,{children:[e.jsx(ee,{value:"Todos",children:"Todos os clientes"}),L.map(s=>e.jsx(ee,{value:s,children:s},s))]})]}),e.jsxs(N,{onClick:()=>C(S,j,p||void 0),variant:"outline",size:"sm",disabled:A,children:[e.jsx(ge,{className:`h-4 w-4 mr-2 ${A?"animate-spin":""}`}),"Recarregar"]}),e.jsxs(Z,{variant:I>0?"destructive":"secondary",children:[I," pendentes ",p?`(${p})`:"(todos)"]})]})]})}),e.jsxs(Me,{className:"space-y-4",children:[v.length>0&&e.jsxs(ne,{className:"border-warning/50 bg-warning/10",children:[e.jsx(ie,{className:"h-4 w-4 text-warning"}),e.jsxs(G,{children:[e.jsx("strong",{children:v.length})," ",v.length===1?"item aguarda":"itens aguardam"," relacionamento. O sistema aprende com suas escolhas para melhorar futuras importaÃ§Ãµes."]})]}),K.size>0&&e.jsxs("div",{className:"flex items-center justify-between p-4 bg-muted rounded-lg",children:[e.jsxs("span",{className:"text-sm font-medium",children:[K.size," item(ns) selecionado(s)"]}),e.jsx(N,{onClick:ae,size:"sm",children:"Confirmar SugestÃµes (Score > 0.8)"})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(he,{children:[e.jsx(xe,{children:e.jsxs(z,{children:[e.jsx(f,{className:"w-[50px]",children:e.jsx("input",{type:"checkbox",onChange:s=>{s.target.checked?u(new Set(v.map(i=>i.id_raw).filter(i=>i!==null))):u(new Set)},checked:K.size===v.length&&v.length>0})}),e.jsx(f,{children:"SKU Original / Pedido"}),e.jsx(f,{children:"Cliente / Canal"}),e.jsx(f,{className:"text-center",children:"Qtd"}),e.jsx(f,{className:"text-right",children:"Valor"}),e.jsx(f,{children:"SugestÃµes"}),e.jsx(f,{children:"Relacionar Manual"}),e.jsx(f,{children:"KIT"}),e.jsx(f,{children:"AÃ§Ãµes"})]})}),e.jsx(pe,{children:A?e.jsx(z,{children:e.jsx(x,{colSpan:9,className:"text-center py-8",children:"Carregando..."})}):v.length===0?e.jsx(z,{children:e.jsx(x,{colSpan:9,className:"text-center py-8",children:"Nenhum item pendente de relacionamento"})}):v.map(s=>{var i;return s.id_raw?e.jsxs(z,{children:[e.jsx(x,{children:e.jsx("input",{type:"checkbox",checked:K.has(s.id_raw),onChange:()=>a(s.id_raw)})}),e.jsx(x,{children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-medium",children:s.sku_original||"â€”"}),s.sku_relacionado&&(()=>{const n=c==null?void 0:c.find(d=>(d.SKU||d.sku)===s.sku_relacionado);return n&&(n["Tipo Produto"]||n.tipo_produto)==="KIT"?e.jsxs(Z,{variant:"secondary",className:"text-xs",children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),"KIT"]}):null})()]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Pedido: ",s.id_pedido||"â€”"]})]})}),e.jsx(x,{children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm",children:s.cliente||"â€”"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.canal||"â€”"})]})}),e.jsx(x,{className:"text-center",children:s.qtd??"â€”"}),e.jsx(x,{className:"text-right",children:s.valor_unit!=null?t(s.valor_unit):"â€”"}),e.jsx(x,{children:e.jsx("div",{className:"space-y-1",children:((i=Q[s.id_raw])==null?void 0:i.map((n,g)=>{const d=c==null?void 0:c.find(h=>(h.SKU||h.sku)===n.sku),k=d&&(d["Tipo Produto"]||d.tipo_produto)==="KIT";return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Z,{variant:n.score>.8?"default":"outline",className:"text-xs",children:[(n.score*100).toFixed(0),"%"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-xs truncate max-w-[100px]",title:n.name,children:n.sku}),k&&e.jsxs(Z,{variant:"secondary",className:"text-[10px] px-1 py-0",children:[e.jsx(q,{className:"w-2 h-2 mr-0.5"}),"KIT"]})]}),e.jsx(N,{size:"sm",variant:"ghost",className:"h-6 px-2",onClick:()=>X(s.id_raw,n.sku,"alias"),title:"Aprovar esta sugestÃ£o",children:e.jsx(Re,{className:"h-3 w-3 text-green-600"})}),k&&(d==null?void 0:d.Componentes)&&e.jsxs(qe,{children:[e.jsx(ze,{asChild:!0,children:e.jsx(N,{variant:"ghost",size:"sm",className:"h-6 px-1",children:e.jsx(q,{className:"h-3 w-3"})})}),e.jsx(De,{className:"w-72",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-sm",children:"Componentes do Kit"}),e.jsx("div",{className:"space-y-1 text-xs",children:d.Componentes.map((h,_)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:h["SKU Componente"]}),e.jsxs("span",{className:"text-muted-foreground",children:["Qtd: ",h["Quantidade por Kit"]]})]},_))})]})})]})]},g)}))||e.jsx("span",{className:"text-xs text-muted-foreground",children:"Sem sugestÃµes"})})}),e.jsx(x,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(oe,{value:P[s.id_raw]||"",onValueChange:n=>O(g=>({...g,[s.id_raw]:n})),children:[e.jsx(re,{className:"w-[150px] h-8",children:e.jsx(le,{placeholder:"Selecione SKU"})}),e.jsx(ce,{children:je((c||[]).filter(n=>n&&n.SKU&&String(n.SKU).trim()!==""),"SKU").map(n=>e.jsxs(ee,{value:String(n.SKU),children:[String(n.SKU)," â€” ",n["Nome Produto"]||""]},String(n.SKU)))})]}),P[s.id_raw]&&e.jsx(N,{size:"sm",variant:"outline",className:"h-8",onClick:()=>X(s.id_raw,P[s.id_raw]),children:e.jsx($e,{className:"h-3 w-3"})})]})}),e.jsx(x,{children:e.jsxs(N,{size:"sm",variant:"outline",className:"h-8",onClick:()=>r(s),children:[e.jsx(q,{className:"h-3 w-3 mr-1"}),"KIT"]})}),e.jsx(x,{children:e.jsx(N,{size:"sm",variant:"ghost",className:"h-8",onClick:async()=>{await C(S,j),w({title:"Item ignorado",description:"O item foi removido da lista de pendÃªncias."})},children:e.jsx(Ae,{className:"h-3 w-3"})})})]},s.id_raw):null})})]})}),I>0&&e.jsx(Be,{currentPage:S,totalPages:Math.ceil(I/j),pageSize:j,totalItems:I,onPageChange:s=>{m(s),u(new Set)},onPageSizeChange:s=>{D(s),m(1),u(new Set)}})]})]}),b&&e.jsx(Ve,{isOpen:se,onClose:()=>{E(!1),M(null)},onKitRelated:o,rawId:b.id_raw,skuOriginal:b.sku_original||"",availableProducts:c||[]})]})});export{He as RelateItemsTab};

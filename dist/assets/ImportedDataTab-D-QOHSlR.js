import{r as t,p as q,q as H,a as K,j as e,s as b,t as Q,v as G,o as J,C as O,c as X,d as W,e as Y,B as m,R as v,f as Z,S as M,g as P,h as B,i as z,k as h,w as ee,I as se,n as ae,T as te,x as ie,y as p,z as n,D as le,E as i,G as ne,H as re}from"./index-Cc8Dvf1k.js";import{u as de}from"./useImportData-z9QLlESq.js";const me=t.memo(function(){const{selectedClientId:j,setSelectedClientId:F,availableClients:L,isLoadingClients:C}=q(),[y,w]=t.useState([]),[c,g]=t.useState(1),[o]=t.useState(50),[a,S]=t.useState({client_id:j||void 0,page:1,page_size:50}),[_,V]=t.useState(""),f=H(_,500),[T,k]=t.useState(!1),{toast:u}=K();t.useEffect(()=>{S(s=>({...s,client_id:j||void 0}))},[j]);const{summary:r,isLoading:l,loadSummary:I,loadImportRows:R,autoRelateAll:D}=de(),x=t.useCallback(async()=>{try{const[s]=await Promise.all([R({clientId:a.client_id,importId:a.import_id,status:a.status,q:f||void 0,page:c,pageSize:o}),I(a.client_id,a.import_id)]);w(s)}catch(s){console.error("Error loading data:",s),w([])}},[a,f,c,o,R,I]);t.useEffect(()=>{let s=!0;return s&&x(),()=>{s=!1}},[c,a,f]);const E=t.useCallback(async()=>{if(!l)try{await D(a.client_id),await x()}catch{}},[l,D,a.client_id,x]),A=t.useCallback(s=>s==="matched"?e.jsxs(b,{className:"bg-success/10 text-success border-success/20",children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"Relacionado"]}):e.jsxs(b,{variant:"outline",className:"text-muted-foreground",children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),"Pendente"]}),[]),U=t.useCallback(s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s),[]),N=t.useMemo(()=>Math.ceil(r.total/o),[r.total,o]),$=t.useCallback(async()=>{var s;if(!a.client_id){u({title:"Erro",description:"Informe import ou cliente.",variant:"destructive"});return}k(!0);try{const d=await J.emitirVendas({client_id:a.client_id,source:"ML"});d.candidatos===0&&d.full_skipped>0?u({title:"Todos eram FULL",description:"Todos os pedidos eram Mercado Fulfillment (sem baixa/financeiro).",variant:"default"}):u({title:"Vendas emitidas com sucesso",description:`Emitidos: ${d.inseridos} | Já existiam: ${d.ja_existiam} | FULL: ${d.full_skipped}`}),await x()}catch(d){u({title:"Erro ao emitir vendas",description:((s=d.message)==null?void 0:s.slice(0,180))||"Verifique o log",variant:"destructive"})}finally{k(!1)}},[a.client_id,u,x]);return e.jsx("div",{className:"space-y-4",children:e.jsxs(O,{children:[e.jsx(X,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(W,{className:"text-lg",children:"Dados Importados"}),e.jsx(Y,{children:"Visualize e gerencie os dados importados"})]}),e.jsxs(m,{onClick:E,size:"sm",className:"hidden sm:flex",disabled:l,children:[e.jsx(v,{className:`h-4 w-4 mr-2 ${l?"animate-spin":""}`}),"Auto-Relacionar"]})]})}),e.jsxs(Z,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs(M,{value:j||"Todos",onValueChange:s=>{F(s==="Todos"?null:s),g(1)},disabled:C,children:[e.jsx(P,{className:"w-[200px]",children:e.jsx(B,{placeholder:C?"Carregando...":"Todos os clientes"})}),e.jsxs(z,{children:[e.jsx(h,{value:"Todos",children:"Todos os clientes"}),L.map(s=>e.jsx(h,{value:s,children:s},s))]})]}),e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(se,{placeholder:"Buscar SKU, pedido, cliente...",value:_,onChange:s=>V(s.target.value),className:"pl-9"})]})}),e.jsxs(M,{value:a.status||"Todos",onValueChange:s=>S({...a,status:s==="Todos"?void 0:s}),children:[e.jsx(P,{className:"w-[140px]",children:e.jsx(B,{placeholder:"Status"})}),e.jsxs(z,{children:[e.jsx(h,{value:"Todos",children:"Todos"}),e.jsx(h,{value:"relacionados",children:"Relacionados"}),e.jsx(h,{value:"pendentes",children:"Pendentes"})]})]}),e.jsxs(m,{onClick:x,variant:"outline",children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),"Atualizar"]}),e.jsxs(m,{onClick:E,variant:"default",disabled:l,children:[e.jsx(v,{className:`h-4 w-4 mr-2 ${l?"animate-spin":""}`}),"Auto-Relacionar"]}),e.jsx(m,{onClick:$,variant:"default",disabled:T||!a.client_id,className:"bg-primary",children:T?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin mr-2",children:"⏳"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Emitir pendentes deste cliente"]})})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:[e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3 border",children:[e.jsx("div",{className:"text-2xl font-bold",children:r.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total"})]}),e.jsxs("div",{className:"bg-success/10 rounded-lg p-3 border border-success/20",children:[e.jsx("div",{className:"text-2xl font-bold text-success",children:r.relacionados}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Relacionados"})]}),e.jsxs("div",{className:"bg-warning/10 rounded-lg p-3 border border-warning/20",children:[e.jsx("div",{className:"text-2xl font-bold text-warning",children:r.pendentes}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pendentes"})]}),e.jsxs("div",{className:"bg-primary/10 rounded-lg p-3 border border-primary/20",children:[e.jsxs("div",{className:"text-2xl font-bold text-primary",children:[Number(r.taxa_match??0).toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Taxa Match"})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(te,{children:[e.jsx(ie,{children:e.jsxs(p,{children:[e.jsx(n,{children:"ID Pedido"}),e.jsx(n,{children:"Data"}),e.jsx(n,{children:"SKU Original"}),e.jsx(n,{children:"SKU Relacionado"}),e.jsx(n,{className:"text-center",children:"Qtd"}),e.jsx(n,{className:"text-right",children:"Valor Unit."}),e.jsx(n,{children:"Cliente"}),e.jsx(n,{children:"Canal"}),e.jsx(n,{children:"Status"})]})}),e.jsx(le,{children:l?e.jsx(p,{children:e.jsx(i,{colSpan:9,className:"text-center py-8",children:"Carregando..."})}):y.length===0?e.jsx(p,{children:e.jsx(i,{colSpan:9,className:"text-center py-8",children:"Nenhum dado encontrado"})}):y.map(s=>e.jsxs(p,{children:[e.jsx(i,{className:"font-medium",children:s.id_pedido}),e.jsx(i,{children:s.data?ne(new Date(s.data),"dd/MM/yyyy",{locale:re}):"-"}),e.jsx(i,{className:"max-w-[200px] truncate",title:s.sku_original,children:s.sku_original}),e.jsx(i,{children:s.sku_relacionado?e.jsx(b,{variant:"outline",children:s.sku_relacionado}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(i,{className:"text-center",children:s.qtd||"-"}),e.jsx(i,{className:"text-right",children:s.valor_unit?U(s.valor_unit):"-"}),e.jsx(i,{children:s.cliente||"-"}),e.jsx(i,{children:s.canal||"-"}),e.jsx(i,{children:A(s.status)})]},s.id_raw))})]})}),N>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Mostrando ",(c-1)*o+1," a ",Math.min(c*o,r.total)," de ",r.total," registros"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{variant:"outline",size:"sm",onClick:()=>g(s=>Math.max(1,s-1)),disabled:c===1||l,children:"Anterior"}),e.jsx(m,{variant:"outline",size:"sm",onClick:()=>g(s=>Math.min(N,s+1)),disabled:c===N||l,children:"Próxima"})]})]})]})]})})});export{me as ImportedDataTab};

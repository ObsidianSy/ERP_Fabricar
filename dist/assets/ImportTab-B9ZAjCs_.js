import{r as t,u as M,a as R,b as B,j as e,C as v,c as N,d as b,e as _,f as y,S as z,g as O,h as J,i as K,k as X,F as H,B as S,U,A as Q,l as G,m as W,n as Y,o as q}from"./index-Cc8Dvf1k.js";import{P as Z}from"./progress-CmDOGqJ5.js";const te=t.memo(function(){const{usuario:l}=M(),[x,w]=t.useState(""),[n,u]=t.useState(null),[h,d]=t.useState(!1),[j,o]=t.useState(0),[C,m]=t.useState(""),[p,D]=t.useState(null),[I,E]=t.useState(!1),f=t.useRef(null),{toast:r}=R(),{data:P}=B("Clientes");t.useEffect(()=>()=>{f.current&&f.current.close()},[]);const T=s=>{var g;const a=(g=s.target.files)==null?void 0:g[0];a&&u(a)},k=async()=>{if(!x||!n){r({title:"Campos obrigat√≥rios",description:"Por favor, selecione um cliente e um arquivo.",variant:"destructive"});return}d(!0),o(0),m("Enviando arquivo...");try{const a=(await q.uploadFile(x,n,"ML",void 0,(l==null?void 0:l.email)||"usuario@sistema.com",(l==null?void 0:l.nome)||"Usu√°rio Sistema")).import_id;D(a);const g="https://docker-opus-unified.q4xusi.easypanel.host",c=new EventSource(`${g}/api/envios/upload-progress/${a}`);f.current=c,c.onmessage=L=>{const i=JSON.parse(L.data),F=i.current;o(F),m(i.message),console.log(`üìä Progresso recebido: ${F}% - ${i.stage} - ${i.message}`),i.stage==="completed"&&(c.close(),o(100),m("‚úÖ Upload conclu√≠do com sucesso!"),r({title:"‚úÖ Upload conclu√≠do!",description:i.message,duration:5e3}),setTimeout(()=>{u(null),o(0),m(""),d(!1)},3e3)),i.stage==="error"&&(c.close(),d(!1),o(0),r({title:"Erro no upload",description:i.message||"Falha ao processar arquivo",variant:"destructive",duration:5e3}))},c.onerror=()=>{c.close(),d(!1),r({title:"Erro no progresso",description:"Conex√£o de progresso perdida, mas upload pode ter sido conclu√≠do.",variant:"destructive"})}}catch{d(!1),o(0),m(""),r({title:"Erro no upload",description:"Falha ao enviar arquivo. Tente novamente.",variant:"destructive"})}},A=s=>{s.preventDefault();const a=s.dataTransfer.files[0];a&&u(a)},V=s=>{s.preventDefault()},$=async()=>{var s;if(!p){r({title:"Erro",description:"ID de importa√ß√£o n√£o encontrado.",variant:"destructive"});return}console.log("üîç ImportTab - importId:",p),E(!0);try{const a=await q.emitirVendas({import_id:p});a.candidatos===0&&a.full_skipped>0?r({title:"Todos eram FULL",description:"Todos os pedidos eram Mercado Fulfillment (sem baixa/financeiro).",variant:"default"}):r({title:"Vendas emitidas com sucesso",description:`Emitidos: ${a.inseridos} | J√° existiam: ${a.ja_existiam} | FULL: ${a.full_skipped}`})}catch(a){r({title:"Erro ao emitir vendas",description:((s=a.message)==null?void 0:s.slice(0,180))||"Verifique o log",variant:"destructive"})}finally{E(!1)}};return e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs(v,{className:"md:col-span-1",children:[e.jsxs(N,{className:"pb-4",children:[e.jsx(b,{className:"text-lg",children:"Importar Planilha"}),e.jsx(_,{children:"Upload de arquivo"})]}),e.jsxs(y,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-1",children:["Cliente",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs(z,{value:x,onValueChange:w,children:[e.jsx(O,{className:"w-full",children:e.jsx(J,{placeholder:"Selecione um cliente"})}),e.jsx(K,{children:P.map(s=>e.jsx(X,{value:s.Nome,children:s.Nome},s.Nome))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-1",children:["Arquivo",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 rounded-lg p-6 text-center hover:border-primary/50 hover:bg-muted/50 transition-all cursor-pointer group",onDrop:A,onDragOver:V,onClick:()=>{var s;return(s=document.getElementById("file-input"))==null?void 0:s.click()},children:[e.jsx("input",{id:"file-input",type:"file",accept:".csv,.xlsx,.xls",onChange:T,className:"hidden"}),n?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"p-3 bg-primary/10 rounded-full w-fit mx-auto",children:e.jsx(H,{className:"h-8 w-8 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:n.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(n.size/1024/1024).toFixed(2)," MB"]})]}),e.jsx(S,{variant:"outline",size:"sm",onClick:s=>{s.stopPropagation(),u(null)},children:"Remover arquivo"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"p-3 bg-muted rounded-full w-fit mx-auto group-hover:bg-primary/10 transition-colors",children:e.jsx(U,{className:"h-8 w-8 text-muted-foreground group-hover:text-primary transition-colors"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:"Arraste o arquivo aqui"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"ou clique para selecionar"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"CSV, XLSX (m√°x. 10MB)"})]})]})]})]}),h&&e.jsxs("div",{className:"space-y-3 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:j===100?"‚úÖ Conclu√≠do":"‚è≥ Processando..."}),e.jsxs("span",{className:"font-bold text-primary",children:[j,"%"]})]}),e.jsx(Z,{value:j,className:`h-3 transition-all ${j===100?"bg-green-100":""}`}),C&&e.jsx("p",{className:"text-sm text-muted-foreground",children:C})]}),e.jsx(S,{onClick:k,disabled:!x||!n||h,className:"w-full",size:"default",children:h?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin mr-2",children:"‚è≥"}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Enviar Planilha"]})})]})]}),e.jsxs("div",{className:"space-y-4",children:[p&&!h&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Q,{className:"border-success/50 bg-success/10",children:[e.jsx(G,{className:"h-4 w-4 text-success"}),e.jsxs(W,{children:[e.jsx("strong",{children:"Importa√ß√£o iniciada!"}),e.jsx("br",{}),"ID: ",e.jsx("code",{className:"text-xs bg-background px-1 py-0.5 rounded",children:p}),e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:'Acesse "Dados Importados" para visualizar.'})]})]}),e.jsx(S,{onClick:$,disabled:I,className:"w-full",variant:"default",children:I?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin mr-2",children:"‚è≥"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Emitir vendas deste import"]})})]}),e.jsxs(v,{children:[e.jsx(N,{className:"pb-3",children:e.jsx(b,{className:"text-base",children:"Instru√ß√µes"})}),e.jsx(y,{children:e.jsxs("ul",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-1",children:"‚Ä¢"}),e.jsx("span",{children:"Selecione o cliente correspondente aos dados"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-1",children:"‚Ä¢"}),e.jsx("span",{children:"Fa√ßa upload de arquivos CSV ou Excel (.xlsx, .xls)"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-1",children:"‚Ä¢"}),e.jsx("span",{children:"O arquivo deve conter colunas: ID Pedido, Data, SKU, Quantidade, Valor"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-1",children:"‚Ä¢"}),e.jsx("span",{children:"Ap√≥s o upload, os dados ser√£o processados automaticamente"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-1",children:"‚Ä¢"}),e.jsx("span",{children:'Use a aba "Relacionar Itens" para vincular SKUs n√£o reconhecidos'})]})]})})]}),e.jsxs(v,{children:[e.jsx(N,{className:"pb-3",children:e.jsx(b,{className:"text-base",children:"Importa√ß√µes Recentes"})}),e.jsx(y,{children:e.jsx("div",{className:"space-y-2",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Nenhuma importa√ß√£o recente"})})})]})]})]})});export{te as ImportTab};

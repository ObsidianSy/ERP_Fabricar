import{a3 as Te,a8 as Le,r,a9 as $e,aa as ze,j as e,a7 as pe,ab as le,ac as Ke,ad as qe,ae as Ue,a4 as de,Y as W,p as Oe,a as Be,C as Me,c as Fe,d as De,e as He,f as Ve,S as Ze,g as Je,h as Qe,i as Xe,k as Ge,I as We,B as $,w as ue,T as he,x as me,y as q,z as k,D as xe,E as f,s as z,A as Z,P as J,m as Q,l as Ye,Z as es,_ as ss,af as X,$ as ts,ag as as,ah as ns,ai as rs,aj as os,ak as is,al as cs,a0 as ls,am as ds}from"./index-Cc8Dvf1k.js";import{u as us}from"./useFullImportData-CU7LmA3j.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=Te("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);var Y="Checkbox",[hs,ys]=Le(Y),[ms,xs]=hs(Y),fe=r.forwardRef((h,g)=>{const{__scopeCheckbox:l,name:c,checked:C,defaultChecked:m,required:S,disabled:j,value:_="on",onCheckedChange:I,form:v,...o}=h,[x,E]=r.useState(null),T=$e(g,p=>E(p)),K=r.useRef(!1),U=x?v||!!x.closest("form"):!0,[y=!1,O]=ze({prop:C,defaultProp:m,onChange:I}),F=r.useRef(y);return r.useEffect(()=>{const p=x==null?void 0:x.form;if(p){const R=()=>O(F.current);return p.addEventListener("reset",R),()=>p.removeEventListener("reset",R)}},[x,O]),e.jsxs(ms,{scope:l,state:y,disabled:j,children:[e.jsx(pe.button,{type:"button",role:"checkbox","aria-checked":A(y)?"mixed":y,"aria-required":S,"data-state":ve(y),"data-disabled":j?"":void 0,disabled:j,value:_,...o,ref:T,onKeyDown:le(h.onKeyDown,p=>{p.key==="Enter"&&p.preventDefault()}),onClick:le(h.onClick,p=>{O(R=>A(R)?!0:!R),U&&(K.current=p.isPropagationStopped(),K.current||p.stopPropagation())})}),U&&e.jsx(ps,{control:x,bubbles:!K.current,name:c,value:_,checked:y,required:S,disabled:j,form:v,style:{transform:"translateX(-100%)"},defaultChecked:A(m)?!1:m})]})});fe.displayName=Y;var ge="CheckboxIndicator",je=r.forwardRef((h,g)=>{const{__scopeCheckbox:l,forceMount:c,...C}=h,m=xs(ge,l);return e.jsx(Ke,{present:c||A(m.state)||m.state===!0,children:e.jsx(pe.span,{"data-state":ve(m.state),"data-disabled":m.disabled?"":void 0,...C,ref:g,style:{pointerEvents:"none",...h.style}})})});je.displayName=ge;var ps=h=>{const{control:g,checked:l,bubbles:c=!0,defaultChecked:C,...m}=h,S=r.useRef(null),j=qe(l),_=Ue(g);r.useEffect(()=>{const v=S.current,o=window.HTMLInputElement.prototype,E=Object.getOwnPropertyDescriptor(o,"checked").set;if(j!==l&&E){const T=new Event("click",{bubbles:c});v.indeterminate=A(l),E.call(v,A(l)?!1:l),v.dispatchEvent(T)}},[j,l,c]);const I=r.useRef(A(l)?!1:l);return e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:C??I.current,...m,tabIndex:-1,ref:S,style:{...h.style,..._,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function A(h){return h==="indeterminate"}function ve(h){return A(h)?"indeterminate":h?"checked":"unchecked"}var ke=fe,fs=je;const be=r.forwardRef(({className:h,...g},l)=>e.jsx(ke,{ref:l,className:de("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",h),...g,children:e.jsx(fs,{className:de("flex items-center justify-center text-current"),children:e.jsx(W,{className:"h-4 w-4"})})}));be.displayName=ke.displayName;const gs={exact:{label:"Exato",variant:"default"},alias:{label:"Alias",variant:"secondary"},prefix:{label:"Prefixo",variant:"outline"},fuzzy:{label:"Aproximado",variant:"outline"}},Cs=r.memo(function({initialEnvioNum:g,initialClienteNome:l}){const{selectedClientId:c,setSelectedClientId:C,availableClients:m,isLoadingClients:S}=Oe(),[j,_]=r.useState(""),[I,v]=r.useState(!1),[o,x]=r.useState(null),[E,T]=r.useState({}),[K,U]=r.useState({}),[y,O]=r.useState({}),[F,p]=r.useState(!1),[R,ee]=r.useState(!1),[se,te]=r.useState(!1),[Ne,D]=r.useState(!1),[H,ye]=r.useState(null),{toast:P}=Be(),{envios:ae,pendings:ne,summary:L,currentEnvioId:js,isLoading:B,loadEnvios:Ce,loadEnvioDetails:w,matchLine:we,searchSku:vs}=us(),[M,re]=r.useState([]),[ks,oe]=r.useState(!0);r.useEffect(()=>{(async()=>{try{oe(!0);const a=await(await fetch(`${X}/api/estoque`)).json();re(a||[])}catch(t){console.error("Erro ao carregar produtos:",t),re([])}finally{oe(!1)}})()},[]);const V=Array.isArray(ae)?ae:[],b=Array.isArray(ne)?ne:[];r.useMemo(()=>m.find(s=>s===c),[m,c]);const Se={"New Seven":1,Realistt:2,"Obsidian Ecom":3,zack:4};r.useEffect(()=>{l&&!c&&C(l)},[l,c,C]),r.useEffect(()=>{if(g&&l&&!o){const s=Se[l];s&&(_(g),setTimeout(async()=>{try{const t=await w(l,g);t&&(x({cliente:l,envioNum:g,envioId:t.envioId,clientId:s}),v(!1))}catch(t){console.error("Erro ao carregar envio automaticamente:",t)}},100))}},[g,l,o,w]);const ie=r.useCallback(s=>{if(!M||M.length===0)return[];const t=s.toUpperCase().trim();if(t===""||t==="*")return M.slice(0,100).map(i=>({sku:i.sku,nome:i.nome,preco_unitario:i.preco_unitario,quantidade_atual:i.quantidade_atual,is_kit:i.is_kit||i.tipo_produto==="KIT",foto_url:i.foto_url,source:"fuzzy",score:1}));const a=[];return M.forEach(i=>{const d=(i.sku||"").toUpperCase(),n=(i.nome||"").toUpperCase();let u=0,N="fuzzy";d===t?(u=1,N="exact"):d.startsWith(t)?(u=.8,N="prefix"):d.includes(t)?(u=.6,N="fuzzy"):n.includes(t)&&(u=.4,N="fuzzy"),u>0&&a.push({sku:i.sku,nome:i.nome,preco_unitario:i.preco_unitario,quantidade_atual:i.quantidade_atual,is_kit:i.is_kit||i.tipo_produto==="KIT",foto_url:i.foto_url,source:N,score:u})}),a.sort((i,d)=>d.score!==i.score?d.score-i.score:i.sku.localeCompare(d.sku)).slice(0,100)},[M]),ce=async()=>{if(!c){P({title:"Cliente nÃ£o selecionado",description:"Por favor, selecione um cliente.",variant:"destructive"});return}p(!0);try{const s={"New Seven":1,Realistt:2,"Obsidian Ecom":3,zack:4};if(j.trim()){const t=await w(c,j.trim());t&&t.envioId?(v(!1),x({cliente:c,envioNum:j.trim(),envioId:t.envioId,clientId:s[c]||1}),P({title:"Envio carregado",description:`${t.pendings.length} ${t.pendings.length===1?"pendÃªncia encontrada":"pendÃªncias encontradas"}.`})):P({title:"Envio nÃ£o encontrado",description:"NÃ£o foi possÃ­vel encontrar o envio especificado.",variant:"destructive"})}else{const t=await w(c,"");t&&t.envioId?(v(!1),x({cliente:c,envioNum:t.envioNum||"",envioId:t.envioId,clientId:s[c]||1}),P({title:"Envio mais recente carregado",description:`Envio ${t.envioNum} com ${t.pendings.length} ${t.pendings.length===1?"pendÃªncia":"pendÃªncias"}.`})):(await Ce(c),v(!0),x(null))}}finally{p(!1)}},_e=async s=>{if(!c)return;_(s),v(!1);const t={"New Seven":1,Realistt:2,"Obsidian Ecom":3,zack:4},a=await w(c,s);a&&a.envioId&&x({cliente:c,envioNum:s,envioId:a.envioId,clientId:t[c]||1})},Ie=async s=>{if(!o)return;const t=b.find(n=>{const u=n.raw_id??n.id;return(typeof u=="string"?parseInt(u):u)===s}),a=K[s];if(!t||!a){console.error("âŒ Pending ou SKU nÃ£o selecionado:",{rawId:s,pending:t,selectedSku:a});return}const i=t.raw_id||t.id;console.log("ðŸ“¤ Enviando para matchLine:",{rawId:parseInt(i),matchedSku:a.sku,createAlias:y[s]??!0,aliasText:t.sku_texto}),(await we({rawId:parseInt(i),matchedSku:a.sku,createAlias:y[s]??!0,aliasText:t.sku_texto})).ok&&(await w(o.cliente,o.envioNum),T(n=>({...n,[s]:[]})),U(n=>({...n,[s]:null})))},Ee=async()=>{if(o){ee(!0);try{const s=await fetch("/api/envios/auto-relate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({envio_id:o.envioId,source:"FULL"})});if(!s.ok){const a=await s.json().catch(()=>({message:"Erro ao auto-relacionar"}));throw new Error(a.message)}const t=await s.json();P({title:"Auto-relacionamento concluÃ­do",description:`${t.matched} itens relacionados automaticamente`}),await w(o.cliente,o.envioNum)}catch(s){console.error("Erro no auto-relacionamento:",s),P({title:"Erro ao auto-relacionar",description:s.message||"NÃ£o foi possÃ­vel auto-relacionar os itens",variant:"destructive"})}finally{ee(!1)}}},Re=async()=>{if(o){te(!0);try{const s=await fetch("/api/envios/emitir-vendas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({envio_id:o.envioId,source:"FULL"})});if(!s.ok){const a=await s.json().catch(()=>({message:"Erro ao emitir vendas"}));throw new Error(a.message||a.error)}const t=await s.json();P({title:"Vendas emitidas com sucesso! ðŸŽ‰",description:`${t.items_count} SKUs processados. Estoque atualizado.`}),await w(o.cliente,o.envioNum)}catch(s){console.error("Erro ao emitir vendas:",s),P({title:"Erro ao emitir vendas",description:s.message||"NÃ£o foi possÃ­vel emitir as vendas",variant:"destructive"})}finally{te(!1)}}},Pe=r.useCallback(s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s),[]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(Me,{children:[e.jsxs(Fe,{className:"pb-4",children:[e.jsx(De,{className:"text-lg",children:"Relacionar Itens FULL"}),e.jsx(He,{children:"Busque um envio e vincule os itens pendentes com SKUs do estoque"})]}),e.jsxs(Ve,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(Ze,{value:c||"none",onValueChange:s=>{s!=="none"&&C(s)},disabled:S,children:[e.jsx(Je,{className:"bg-background",children:e.jsx(Qe,{placeholder:S?"Carregando...":"Selecione o cliente"})}),e.jsx(Xe,{className:"z-[100] bg-background",children:m.map(s=>e.jsx(Ge,{value:s,children:s},s))})]}),e.jsx(We,{placeholder:"NÂº envio (opcional - deixe vazio para listar todos)",value:j,onChange:s=>_(s.target.value),onKeyDown:s=>{s.key==="Enter"&&ce()}}),e.jsxs($,{onClick:ce,disabled:F||!c,children:[e.jsx(ue,{className:`h-4 w-4 mr-2 ${F?"animate-spin":""}`}),j.trim()?"Buscar Envio":"Listar Todos"]})]}),I&&V.length>0&&e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(he,{children:[e.jsx(me,{children:e.jsxs(q,{children:[e.jsx(k,{children:"NÂº Envio"}),e.jsx(k,{className:"text-right",children:"Total Itens"}),e.jsx(k,{className:"text-right",children:"Registrados"}),e.jsx(k,{className:"text-right",children:"Pendentes"}),e.jsx(k,{children:"Status"}),e.jsx(k,{className:"text-right",children:"AÃ§Ã£o"})]})}),e.jsx(xe,{children:V.map(s=>e.jsxs(q,{children:[e.jsx(f,{className:"font-mono font-medium",children:s.envio_num}),e.jsxs(f,{className:"text-right",children:[s.tot_itens," (",s.tot_qtd," un)"]}),e.jsx(f,{className:"text-right text-green-600",children:s.registrados_itens}),e.jsx(f,{className:"text-right text-destructive",children:s.pendentes_itens}),e.jsx(f,{children:e.jsx(z,{variant:s.status==="registrado"?"default":"secondary",children:s.status})}),e.jsx(f,{className:"text-right",children:e.jsx($,{size:"sm",variant:"outline",onClick:()=>_e(s.envio_num),disabled:s.pendentes_itens===0,children:s.pendentes_itens>0?"Relacionar":"Completo"})})]},`${s.envio_id}-${s.envio_num}`))})]})}),I&&V.length===0&&!B&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhum envio encontrado para este cliente"}),!I&&o&&L&&e.jsxs(Z,{children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx(Q,{children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("span",{children:[e.jsx("strong",{children:"Envio:"})," ",o.envioNum]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Itens:"})," ",L.tot_itens]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Qtd Total:"})," ",L.tot_qtd]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Registrados:"})," ",L.registrados_itens," itens (",L.registrados_qtd," un)"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Pendentes:"})," ",L.pendentes_itens," itens (",L.pendentes_qtd," un)"]})]})})]}),!I&&o&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(z,{variant:b.length>0?"destructive":"secondary",children:[b.length," pendentes"]}),b.length>0&&e.jsxs($,{size:"sm",variant:"default",onClick:Ee,disabled:R||B,className:"gap-2 bg-purple-600 hover:bg-purple-700",children:[e.jsx(G,{className:"h-4 w-4"}),R?"Auto-relacionando...":"Auto-Relacionar"]}),e.jsxs($,{size:"sm",variant:"default",onClick:Re,disabled:se||B,className:"gap-2 bg-green-600 hover:bg-green-700",children:[e.jsx(J,{className:"h-4 w-4"}),se?"Emitindo...":"Emitir Vendas"]}),b.length===0&&e.jsxs(z,{variant:"default",className:"bg-green-600",children:[e.jsx(W,{className:"h-3 w-3 mr-1"}),"Pronto!"]})]}),b.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(Z,{className:"border-warning/50 bg-warning/10",children:[e.jsx(Ye,{className:"h-4 w-4 text-warning"}),e.jsxs(Q,{children:[e.jsx("strong",{children:b.length})," ",b.length===1?"item aguarda":"itens aguardam"," relacionamento. Busque e selecione o SKU correspondente. O sistema aprenderÃ¡ com suas escolhas."]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(he,{children:[e.jsx(me,{children:e.jsxs(q,{children:[e.jsx(k,{children:"CÃ³digo ML"}),e.jsx(k,{children:"SKU Texto"}),e.jsx(k,{className:"text-center",children:"Qtd"}),e.jsx(k,{className:"w-[350px]",children:"Buscar SKU"}),e.jsx(k,{className:"text-center",children:"Criar Alias"}),e.jsx(k,{className:"text-center",children:"AÃ§Ã£o"})]})}),e.jsx(xe,{children:B?e.jsx(q,{children:e.jsx(f,{colSpan:6,className:"text-center py-8",children:"Carregando..."})},"loading"):b.length===0?e.jsx(q,{children:e.jsx(f,{colSpan:6,className:"text-center py-8",children:"Nenhum item pendente"})},"empty"):b.map(s=>{const t=s.raw_id??s.id,a=typeof t=="string"?parseInt(t):t,i=E[a]||[],d=K[a];return e.jsxs(q,{children:[e.jsx(f,{children:e.jsx("p",{className:"font-medium",children:s.codigo_ml||"â€”"})}),e.jsx(f,{children:e.jsx("p",{className:"font-medium",children:s.sku_texto})}),e.jsx(f,{className:"text-center",children:e.jsx(z,{variant:"outline",children:s.qtd})}),e.jsx(f,{children:e.jsxs(es,{children:[e.jsx(ss,{asChild:!0,children:e.jsxs($,{variant:"outline",className:"w-full justify-start",onClick:()=>{if(!E[a]||E[a].length===0){const n=ie("*");T(u=>({...u,[a]:n}))}},children:[d!=null&&d.foto_url?e.jsx("img",{src:`${X}${d.foto_url}`,alt:d.sku,className:"h-6 w-6 mr-2 rounded object-cover bg-muted"}):e.jsx(ue,{className:"h-4 w-4 mr-2"}),d?`${d.sku} - ${d.nome}`:"Buscar SKU..."]})}),e.jsx(ts,{className:"w-[400px] p-0 z-[90] bg-background",align:"start",children:e.jsxs(as,{children:[e.jsx(ns,{placeholder:"Pesquisar SKU...",onValueChange:n=>{const u=ie(n);T(N=>({...N,[a]:u}))}}),e.jsx(rs,{className:"max-h-[300px]",children:i.length===0?e.jsx(os,{children:"Carregando SKUs..."}):e.jsx(is,{children:i.map((n,u)=>{const N=gs[n.source]||{label:"Busca",variant:"outline"};return e.jsxs(cs,{value:`${n.sku} ${n.nome}`,onSelect:()=>{U(Ae=>({...Ae,[a]:n}))},className:"flex items-start gap-2 p-3 cursor-pointer",children:[n.foto_url?e.jsx("img",{src:`${X}${n.foto_url}`,alt:n.sku,className:"h-8 w-8 rounded object-cover bg-muted"}):e.jsx("div",{className:"h-8 w-8 rounded bg-muted flex items-center justify-center text-xs font-medium",children:(n.sku||"?").slice(0,2)}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:n.sku}),e.jsx(z,{variant:N.variant,className:"text-[10px]",children:N.label}),n.is_kit&&e.jsx(z,{variant:"outline",className:"text-[10px]",children:"KIT"}),e.jsxs(z,{variant:"secondary",className:"text-[10px]",children:[Math.round((n.score||0)*100),"%"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:n.nome}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Estoque: ",n.quantidade_atual||0]}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:Pe(n.preco_unitario||0)})]})]}),e.jsx(G,{className:"h-4 w-4 text-primary opacity-50"})]},`${a}-${n.sku}-${n.source}-${u}`)})})})]})})]})}),e.jsx(f,{className:"text-center",children:e.jsx(be,{checked:y[a]??!0,onCheckedChange:n=>{O(u=>({...u,[a]:!!n}))}})}),e.jsx(f,{className:"text-center",children:e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsxs($,{size:"sm",variant:"outline",onClick:()=>{ye({raw_id:a,sku_texto:s.sku_texto}),D(!0)},className:"gap-2 border-purple-600 text-purple-600 hover:bg-purple-50",children:[e.jsx(J,{className:"h-4 w-4"}),"Kit"]}),e.jsxs($,{size:"sm",onClick:()=>Ie(a),disabled:!d,className:"gap-2",children:[e.jsx(ls,{className:"h-4 w-4"}),"Relacionar"]})]})})]},`${s.id}-${s.row_num}`)})})]})})]}),o&&b.length===0&&!B&&e.jsxs(Z,{className:"border-green-500/50 bg-green-500/10",children:[e.jsx(W,{className:"h-4 w-4 text-green-600"}),e.jsx(Q,{className:"text-green-600",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),e.jsx("span",{children:"Todas as pendÃªncias foram resolvidas! As vendas foram emitidas automaticamente."})]})})]})]})]}),H&&e.jsx(ds,{open:Ne,onOpenChange:D,rawId:H.raw_id,skuOriginal:H.sku_texto,envioId:o==null?void 0:o.envioId,onKitRelated:s=>{console.log("Kit relacionado:",s),D(!1),o&&w(o.cliente,o.envioNum)}})]})});export{Cs as FullRelateItemsTab};
